{
  "name": "Chat Processing Flow",
  "description": "Trigger: New chat message in PVA → Extract intent → Query Data Warehouse → Generate response → Log interaction",
  "trigger": "New message in Power Virtual Agents",
  "actions": [
    {
      "type": "variable",
      "name": "Extract chat message",
      "fields": ["user_id", "user_name", "message_text", "conversation_id", "session_id"]
    },
    {
      "type": "action",
      "name": "Call Azure OpenAI - Extract Intent & Entities",
      "description": "Parse user message to understand intent and extract order_id, customer_id",
      "input": {
        "model": "gpt-4o-mini",
        "prompt": "Extract intent and entities from this customer message:\n'{message_text}'\n\nIntents: order_tracking, returns, product_info, delivery, payment, complaint\nEntities to extract: customer_id (from context), order_id, product_id\n\nReturn JSON.",
        "max_tokens": 150,
        "temperature": 0.2
      },
      "output": {
        "intent": "string",
        "customer_id": "string (or null)",
        "order_id": "string (or null)",
        "product_id": "string (or null)",
        "confidence": "decimal"
      }
    },
    {
      "type": "condition",
      "name": "Can answer with data lookup?",
      "description": "If intent is order_tracking or product_info, query DW",
      "true_path": [
        {
          "type": "action",
          "name": "Query Data Warehouse - Order Status",
          "description": "SQL query to fetch order details from DW",
          "sql": "SELECT o.order_id, o.status, o.fulfillment_status, t.current_location, t.estimated_delivery_date FROM DimOrder o LEFT JOIN silver_tracking_events t ON o.order_id = t.order_id WHERE o.order_id = @order_id ORDER BY t.event_timestamp DESC LIMIT 1;",
          "output": {
            "order_id": "string",
            "status": "string",
            "current_location": "string",
            "estimated_delivery": "timestamp"
          }
        },
        {
          "type": "action",
          "name": "Call Azure OpenAI - Generate Conversational Response",
          "description": "Use order data to compose friendly, natural response",
          "input": {
            "model": "gpt-4o-mini",
            "prompt": "A customer asked: '{message_text}'\n\nHere's their order info:\n{order_data}\n\nGenerate a friendly, concise, accurate response in a conversational tone.",
            "max_tokens": 300,
            "temperature": 0.8
          },
          "output": {
            "response_text": "string",
            "confidence": "decimal",
            "suggested_next_action": "string (escalate/follow-up/close)"
          }
        }
      ],
      "false_path": [
        {
          "type": "action",
          "name": "Escalate to human agent",
          "description": "Hand off to Power Virtual Agents escalation queue"
        }
      ]
    },
    {
      "type": "action",
      "name": "Write to Fabric Lakehouse - Bronze",
      "description": "Store raw chat message",
      "target": "bronze_chat_raw",
      "data": {
        "chat_id": "GUID",
        "conversation_id": "string",
        "user_id": "string",
        "message_text": "string",
        "message_timestamp": "timestamp"
      }
    },
    {
      "type": "action",
      "name": "Write to Fabric Lakehouse - Silver",
      "description": "Store enriched chat with intent & entities",
      "target": "silver_chat_messages",
      "data": {
        "chat_id": "GUID",
        "conversation_id": "string",
        "intent": "string",
        "extracted_order_id": "string",
        "extracted_entities": "JSON",
        "bot_intent": "string",
        "message_timestamp": "timestamp"
      }
    },
    {
      "type": "action",
      "name": "Send response to user",
      "description": "Reply in PVA chat widget"
    },
    {
      "type": "action",
      "name": "Log to FactChatInteraction",
      "description": "Record interaction metrics in Data Warehouse"
    }
  ]
}
